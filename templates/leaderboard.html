{% extends "base.html" %}

{% block title %}Leaderboard - {{ exam.title }}{% endblock %}

{% block content %}
<style>
.tabs {
    display: flex;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 3px solid var(--primary-color);
    background: white;
    border-radius: 10px 10px 0 0;
    overflow: hidden;
}

.tab-button {
    flex: 1;
    padding: 1rem 2rem;
    border: none;
    background: #f8f9fa;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    color: #666;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.tab-button:hover {
    background: #e9ecef;
}

.tab-button.active {
    background: white;
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.leaderboard-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.rank-badge {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: bold;
    color: white;
}

.rank-1 {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
}

.rank-2 {
    background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
}

.rank-3 {
    background: linear-gradient(135deg, #CD7F32 0%, #B8860B 100%);
}

.rank-other {
    background: var(--primary-color);
}

.current-user {
    background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%) !important;
    border: 2px solid var(--primary-color);
    box-shadow: 0 4px 15px rgba(139, 21, 56, 0.2);
}

@media (max-width: 768px) {
    .tabs {
        flex-direction: column;
    }
    
    .tab-button {
        border-bottom: 1px solid #ddd;
    }
    
    .tab-button.active {
        border-bottom: 3px solid var(--primary-color);
    }
    
    .leaderboard-item {
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .rank-badge {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
}
</style>

<h1 style="color: var(--primary-color); margin-bottom: 2rem;">üèÜ Leaderboard: {{ exam.title }}</h1>

<div class="tabs">
    <button class="tab-button active" onclick="switchTab('branch')">
        üìç Cabang Saya
    </button>
    <button class="tab-button" onclick="switchTab('global')">
        üåç Global (Semua Cabang)
    </button>
</div>

<div id="branchTab" class="tab-content active">
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;">Peringkat Cabang: {{ current_user.inspira_branch }}</h2>
        {% if branch_leaderboard %}
            {% for entry in branch_leaderboard %}
            <div class="leaderboard-item {% if entry.user_id == current_user.id %}current-user{% endif %}">
                <div class="rank-badge {% if entry.rank_in_branch == 1 %}rank-1{% elif entry.rank_in_branch == 2 %}rank-2{% elif entry.rank_in_branch == 3 %}rank-3{% else %}rank-other{% endif %}"
                     onclick="{% if entry.rank_in_branch <= 3 %}playVictorySound({{ entry.rank_in_branch }}){% endif %}"
                     style="{% if entry.rank_in_branch <= 3 %}cursor: pointer;{% endif %}">
                    {% if entry.rank_in_branch == 1 %}
                        <span style="font-size: 1.5rem;">üèÜ</span>
                    {% elif entry.rank_in_branch == 2 %}
                        <span style="font-size: 1.5rem;">ü•à</span>
                    {% elif entry.rank_in_branch == 3 %}
                        <span style="font-size: 1.5rem;">ü•â</span>
                    {% else %}
                        {{ entry.rank_in_branch }}
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0;">
                        {{ entry.user.full_name }}
                        {% if entry.user_id == current_user.id %}<span style="color: var(--primary-color); font-weight: bold;"> (Anda)</span>{% endif %}
                    </h3>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        <strong>Kelas:</strong> {{ entry.user.class_level or '-' }} | 
                        <strong>Sekolah:</strong> {{ entry.user.school_name or '-' }}
                    </p>
                    <p style="margin: 0; color: #999; font-size: 0.85rem;">
                        üìç {{ entry.user.inspira_branch or '-' }}
                    </p>
                </div>
                <div style="text-align: right;">
                    <h3 style="margin: 0; color: var(--primary-color);">{{ entry.total_score }}</h3>
                    <p style="margin: 0; color: #666;">Poin</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 2rem;">Belum ada peserta dari cabang ini.</p>
        {% endif %}
    </div>
</div>

<div id="globalTab" class="tab-content">
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;">Peringkat Global (Semua Cabang)</h2>
        {% if global_leaderboard %}
            {% for entry in global_leaderboard %}
            <div class="leaderboard-item {% if entry.user_id == current_user.id %}current-user{% endif %}">
                <div class="rank-badge {% if entry.rank_global == 1 %}rank-1{% elif entry.rank_global == 2 %}rank-2{% elif entry.rank_global == 3 %}rank-3{% else %}rank-other{% endif %}"
                     onclick="{% if entry.rank_global <= 3 %}playVictorySound({{ entry.rank_global }}){% endif %}"
                     style="{% if entry.rank_global <= 3 %}cursor: pointer;{% endif %}">
                    {% if entry.rank_global == 1 %}
                        <span style="font-size: 1.5rem;">üèÜ</span>
                    {% elif entry.rank_global == 2 %}
                        <span style="font-size: 1.5rem;">ü•à</span>
                    {% elif entry.rank_global == 3 %}
                        <span style="font-size: 1.5rem;">ü•â</span>
                    {% else %}
                        {{ entry.rank_global }}
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0;">
                        {{ entry.user.full_name }}
                        {% if entry.user_id == current_user.id %}<span style="color: var(--primary-color); font-weight: bold;"> (Anda)</span>{% endif %}
                    </h3>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        <strong>Kelas:</strong> {{ entry.user.class_level or '-' }} | 
                        <strong>Sekolah:</strong> {{ entry.user.school_name or '-' }}
                    </p>
                    <p style="margin: 0; color: #999; font-size: 0.85rem;">
                        üìç {{ entry.user.inspira_branch or '-' }}
                    </p>
                </div>
                <div style="text-align: right;">
                    <h3 style="margin: 0; color: var(--primary-color);">{{ entry.total_score }}</h3>
                    <p style="margin: 0; color: #666;">Poin</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 2rem;">Belum ada peserta.</p>
        {% endif %}
    </div>
</div>

<div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    <button onclick="playVictorySound(0)" 
            style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); 
                   color: white; 
                   border: none; 
                   width: 60px; 
                   height: 60px; 
                   border-radius: 50%; 
                   cursor: pointer; 
                   font-size: 1.5rem; 
                   box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
                   transition: all 0.3s ease;"
            onmouseover="this.style.transform='scale(1.1)'"
            onmouseout="this.style.transform='scale(1)'">
        üîä
    </button>
    <p style="text-align: center; margin-top: 0.5rem; font-size: 0.75rem; color: #666;">Putar Musik</p>
</div>

<audio id="victoryAudio" src="{{ url_for('static', filename='audio/victory.mp3') }}" preload="auto"></audio>

<script>
function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    if (tab === 'branch') {
        document.querySelector('.tab-button:nth-child(1)').classList.add('active');
        document.getElementById('branchTab').classList.add('active');
    } else {
        document.querySelector('.tab-button:nth-child(2)').classList.add('active');
        document.getElementById('globalTab').classList.add('active');
    }
}

function playVictorySound(rank) {
    console.log('üéµ Attempting to play victory sound for rank:', rank);
    const audio = document.getElementById('victoryAudio');
    if (audio) {
        audio.currentTime = 0;
        audio.volume = 0.7;
        
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise
                .then(() => {
                    console.log('‚úì Audio playing successfully!');
                    
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        color: white;
                        padding: 1rem 1.5rem;
                        border-radius: 10px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        z-index: 10000;
                        animation: slideDown 0.3s ease;
                        font-weight: bold;
                    `;
                    notification.innerHTML = 'üéµ Musik victory sedang diputar!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                })
                .catch(error => {
                    console.error('‚ùå Audio play failed:', error);
                    alert('‚ö†Ô∏è Tidak bisa memutar musik.\n\nSilakan klik icon speaker üîä di pojok kanan atas untuk memutar musik victory!');
                });
        }
    } else {
        console.error('‚ùå Audio element not found!');
    }
}
</script>
{% endblock %}
