{% extends "base.html" %}

{% block title %}Leaderboard - {{ exam.title }}{% endblock %}

{% block content %}
<style>
.tabs {
    display: flex;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 3px solid var(--primary-color);
    background: white;
    border-radius: 10px 10px 0 0;
    overflow: hidden;
}

.tab-button {
    flex: 1;
    padding: 1rem 2rem;
    border: none;
    background: #f8f9fa;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    color: #666;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.tab-button:hover {
    background: #e9ecef;
}

.tab-button.active {
    background: white;
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.leaderboard-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.rank-badge {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: bold;
    color: white;
}

.rank-1 {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
}

.rank-2 {
    background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
}

.rank-3 {
    background: linear-gradient(135deg, #CD7F32 0%, #B8860B 100%);
}

.rank-other {
    background: var(--primary-color);
}

.current-user {
    background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%) !important;
    border: 2px solid var(--primary-color);
    box-shadow: 0 4px 15px rgba(139, 21, 56, 0.2);
}

@media (max-width: 768px) {
    .tabs {
        flex-direction: column;
    }
    
    .tab-button {
        border-bottom: 1px solid #ddd;
    }
    
    .tab-button.active {
        border-bottom: 3px solid var(--primary-color);
    }
    
    .leaderboard-item {
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .rank-badge {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
}
</style>

<h1 style="color: var(--primary-color); margin-bottom: 2rem;">🏆 Leaderboard: {{ exam.title }}</h1>

<div class="tabs">
    <button class="tab-button active" onclick="switchTab('branch')">
        📍 Cabang Saya
    </button>
    <button class="tab-button" onclick="switchTab('global')">
        🌍 Global (Semua Cabang)
    </button>
</div>

<div id="branchTab" class="tab-content active">
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;">Peringkat Cabang: {{ current_user.inspira_branch }}</h2>
        {% if branch_leaderboard %}
            {% for entry in branch_leaderboard %}
            <div class="leaderboard-item {% if entry.user_id == current_user.id %}current-user{% endif %}">
                <div class="rank-badge {% if entry.rank_in_branch == 1 %}rank-1{% elif entry.rank_in_branch == 2 %}rank-2{% elif entry.rank_in_branch == 3 %}rank-3{% else %}rank-other{% endif %}"
                     onclick="{% if entry.rank_in_branch <= 3 %}playVictorySound({{ entry.rank_in_branch }}){% endif %}"
                     style="{% if entry.rank_in_branch <= 3 %}cursor: pointer;{% endif %}">
                    {% if entry.rank_in_branch == 1 %}
                        <span style="font-size: 1.5rem;">🏆</span>
                    {% elif entry.rank_in_branch == 2 %}
                        <span style="font-size: 1.5rem;">🥈</span>
                    {% elif entry.rank_in_branch == 3 %}
                        <span style="font-size: 1.5rem;">🥉</span>
                    {% else %}
                        {{ entry.rank_in_branch }}
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0;">
                        {{ entry.user.full_name }}
                        {% if entry.user_id == current_user.id %}<span style="color: var(--primary-color); font-weight: bold;"> (Anda)</span>{% endif %}
                    </h3>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        <strong>Kelas:</strong> {{ entry.user.class_level or '-' }} | 
                        <strong>Sekolah:</strong> {{ entry.user.school_name or '-' }}
                    </p>
                    <p style="margin: 0; color: #999; font-size: 0.85rem;">
                        📍 {{ entry.user.inspira_branch or '-' }}
                    </p>
                </div>
                <div style="text-align: right;">
                    <h3 style="margin: 0; color: var(--primary-color);">{{ entry.total_score }}</h3>
                    <p style="margin: 0; color: #666;">Poin</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 2rem;">Belum ada peserta dari cabang ini.</p>
        {% endif %}
    </div>
</div>

<div id="globalTab" class="tab-content">
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;">Peringkat Global (Semua Cabang)</h2>
        {% if global_leaderboard %}
            {% for entry in global_leaderboard %}
            <div class="leaderboard-item {% if entry.user_id == current_user.id %}current-user{% endif %}">
                <div class="rank-badge {% if entry.rank_global == 1 %}rank-1{% elif entry.rank_global == 2 %}rank-2{% elif entry.rank_global == 3 %}rank-3{% else %}rank-other{% endif %}"
                     onclick="{% if entry.rank_global <= 3 %}playVictorySound({{ entry.rank_global }}){% endif %}"
                     style="{% if entry.rank_global <= 3 %}cursor: pointer;{% endif %}">
                    {% if entry.rank_global == 1 %}
                        <span style="font-size: 1.5rem;">🏆</span>
                    {% elif entry.rank_global == 2 %}
                        <span style="font-size: 1.5rem;">🥈</span>
                    {% elif entry.rank_global == 3 %}
                        <span style="font-size: 1.5rem;">🥉</span>
                    {% else %}
                        {{ entry.rank_global }}
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0;">
                        {{ entry.user.full_name }}
                        {% if entry.user_id == current_user.id %}<span style="color: var(--primary-color); font-weight: bold;"> (Anda)</span>{% endif %}
                    </h3>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        <strong>Kelas:</strong> {{ entry.user.class_level or '-' }} | 
                        <strong>Sekolah:</strong> {{ entry.user.school_name or '-' }}
                    </p>
                    <p style="margin: 0; color: #999; font-size: 0.85rem;">
                        📍 {{ entry.user.inspira_branch or '-' }}
                    </p>
                </div>
                <div style="text-align: right;">
                    <h3 style="margin: 0; color: var(--primary-color);">{{ entry.total_score }}</h3>
                    <p style="margin: 0; color: #666;">Poin</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 2rem;">Belum ada peserta.</p>
        {% endif %}
    </div>
</div>

<audio id="victoryAudio" src="{{ url_for('static', filename='audio/victory.mp3') }}" preload="auto"></audio>

<script>
let audioUnlocked = false;
let pendingAutoplay = false;

{% set user_rank = 0 %}
{% for entry in branch_leaderboard %}
    {% if entry.user_id == current_user.id %}
        {% set user_rank = entry.rank_in_branch %}
    {% endif %}
{% endfor %}
const currentUserRank = {{ user_rank }};

function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    if (tab === 'branch') {
        document.querySelector('.tab-button:nth-child(1)').classList.add('active');
        document.getElementById('branchTab').classList.add('active');
    } else {
        document.querySelector('.tab-button:nth-child(2)').classList.add('active');
        document.getElementById('globalTab').classList.add('active');
    }
}

function unlockAudio() {
    if (audioUnlocked) return;
    
    const audio = document.getElementById('victoryAudio');
    if (!audio) return;
    
    console.log('🔓 Unlocking audio...');
    audio.muted = true;
    
    const playPromise = audio.play();
    if (playPromise !== undefined) {
        playPromise.then(() => {
            audio.pause();
            audio.currentTime = 0;
            audio.muted = false;
            audioUnlocked = true;
            console.log('✓ Audio unlocked successfully!');
            
            if (pendingAutoplay) {
                setTimeout(() => playVictorySound(currentUserRank), 500);
            }
        }).catch(e => {
            console.log('Audio unlock failed:', e);
        });
    }
}

function playVictorySound(rank) {
    console.log('🎵 Attempting to play victory sound for rank:', rank);
    const audio = document.getElementById('victoryAudio');
    if (!audio) {
        console.error('❌ Audio element not found!');
        return;
    }
    
    if (!audioUnlocked) {
        console.log('⏳ Audio not unlocked yet, waiting...');
        pendingAutoplay = true;
        return;
    }
    
    audio.currentTime = 0;
    audio.volume = 0.7;
    audio.muted = false;
    
    const playPromise = audio.play();
    
    if (playPromise !== undefined) {
        playPromise
            .then(() => {
                console.log('✓ Audio playing successfully!');
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 10000;
                    animation: slideDown 0.3s ease;
                    font-weight: bold;
                `;
                notification.innerHTML = '🎵 Musik victory sedang diputar!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            })
            .catch(error => {
                console.error('❌ Audio play failed:', error);
            });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('📊 Leaderboard loaded. Current user rank:', currentUserRank);
    
    const audio = document.getElementById('victoryAudio');
    if (audio) {
        audio.muted = true;
        audio.play().catch(() => {});
    }
    
    const unlockEvents = ['click', 'touchstart', 'keydown', 'mousemove'];
    const unlockHandler = function() {
        unlockAudio();
        unlockEvents.forEach(event => {
            document.removeEventListener(event, unlockHandler);
        });
    };
    
    unlockEvents.forEach(event => {
        document.addEventListener(event, unlockHandler, { once: true, passive: true });
    });
    
    if (currentUserRank >= 1 && currentUserRank <= 3) {
        pendingAutoplay = true;
        console.log('🏆 User is in top 3! Autoplay will start after first interaction.');
        
        setTimeout(() => {
            if (!audioUnlocked) {
                const banner = document.createElement('div');
                banner.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                    color: #000;
                    padding: 1rem 2rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: bounce 1s ease infinite;
                    font-weight: bold;
                    text-align: center;
                    cursor: pointer;
                `;
                banner.innerHTML = '🏆 Selamat! Klik di mana saja untuk memutar musik victory!';
                banner.onclick = function() {
                    unlockAudio();
                    banner.remove();
                };
                document.body.appendChild(banner);
                
                setTimeout(() => {
                    if (banner.parentNode) {
                        banner.style.animation = 'fadeOut 0.5s ease';
                        setTimeout(() => banner.remove(), 500);
                    }
                }, 5000);
            }
        }, 1000);
    }
});
</script>
{% endblock %}
