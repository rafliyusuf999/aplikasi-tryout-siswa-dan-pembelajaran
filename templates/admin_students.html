{% extends "base.html" %}

{% block title %}Kelola Siswa - Admin{% endblock %}

{% block content %}
<h1 style="color: var(--primary-color); margin-bottom: 2rem;">üë®‚Äçüéì Kelola Siswa</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h2>Daftar Siswa</h2>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <form method="GET" action="{{ url_for('admin_students') }}" style="display: flex; gap: 0.5rem;">
                <input type="text" name="search" class="form-control" placeholder="Cari nama siswa..." value="{{ search_query or '' }}" style="min-width: 200px;">
                <button type="submit" class="btn btn-primary">Cari</button>
                {% if search_query %}
                <a href="{{ url_for('admin_students') }}" class="btn btn-secondary">Reset</a>
                {% endif %}
            </form>
            <button onclick="showModal('addStudentModal')" class="btn btn-primary">+ Tambah Siswa</button>
            <form method="POST" action="{{ url_for('admin_delete_all_students') }}" style="display: inline;" onsubmit="return confirm('PERINGATAN! Anda akan menghapus SEMUA data siswa. Apakah Anda yakin?');">
                <button type="submit" class="btn btn-danger">üóëÔ∏è Hapus Semua Siswa</button>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>Cabang</th>
                    <th>Kelas</th>
                    <th>Sekolah</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr {% if student_cheating_data.get(student.id, 0) > 0 %}style="background-color: #fff3f3;"{% endif %}>
                    <td>{{ student.full_name }}</td>
                    <td>{{ student.email }}</td>
                    <td>{{ student.inspira_branch }}</td>
                    <td>{{ student.class_level }}</td>
                    <td>{{ student.school_name }}</td>
                    <td>
                        {% if student_cheating_data.get(student.id, 0) > 0 %}
                        <span style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: bold; display: inline-block;">
                            ‚õî TERDETEKSI CURANG ({{ student_cheating_data.get(student.id) }}x)
                        </span>
                        {% else %}
                        <span style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: bold; display: inline-block;">
                            ‚úÖ Bersih
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <button 
                            class="btn btn-primary student-detail-btn" 
                            style="padding: 0.5rem 1rem; margin-right: 0.5rem;"
                            data-id="{{ student.id }}"
                            data-name="{{ student.full_name }}"
                            data-email="{{ student.email }}"
                            data-branch="{{ student.inspira_branch }}"
                            data-class="{{ student.class_level }}"
                            data-school="{{ student.school_name }}"
                            data-phone="{{ student.phone_number or '-' }}"
                            data-created="{{ student.created_at.strftime('%d/%m/%Y %H:%M') }}"
                            data-has-cheating="{{ '1' if student_cheating_data.get(student.id, 0) > 0 else '0' }}">
                            Detail
                        </button>
                        <button 
                            class="btn btn-warning student-edit-btn" 
                            style="padding: 0.5rem 1rem; margin-right: 0.5rem;"
                            data-id="{{ student.id }}"
                            data-name="{{ student.full_name }}"
                            data-email="{{ student.email }}"
                            data-branch="{{ student.inspira_branch }}"
                            data-class="{{ student.class_level }}"
                            data-school="{{ student.school_name }}"
                            data-phone="{{ student.phone_number or '' }}">
                            Edit
                        </button>
                        {% if student_cheating_data.get(student.id, 0) > 0 %}
                        <button 
                            class="btn btn-success student-clear-cheating-btn" 
                            style="padding: 0.5rem 1rem; margin-right: 0.5rem;"
                            data-id="{{ student.id }}"
                            data-name="{{ student.full_name }}">
                            ‚úÖ Beri Kesempatan
                        </button>
                        {% endif %}
                        <form method="POST" action="{{ url_for('admin_delete_student', id=student.id) }}" style="display: inline;" data-confirm-delete>
                            <button type="submit" class="btn btn-danger" style="padding: 0.5rem 1rem;">Hapus</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="addStudentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tambah Siswa Baru</h3>
            <span class="close" onclick="closeModal('addStudentModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('admin_add_student') }}">
            <div class="form-group">
                <label>Nama Lengkap:</label>
                <input type="text" name="full_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" name="password" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Cabang:</label>
                <select name="inspira_branch" class="form-control" required>
                    {% for branch in branches %}
                    <option value="{{ branch }}">{{ branch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Kelas:</label>
                <select name="class_level" class="form-control" required>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="Alumni">Alumni</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nama Sekolah:</label>
                <input type="text" name="school_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Nomor HP:</label>
                <input type="tel" name="phone_number" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Tambah</button>
        </form>
    </div>
</div>

<div id="studentDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Biodata Siswa</h3>
            <span class="close" onclick="closeModal('studentDetailsModal')">&times;</span>
        </div>
        <div class="modal-body">
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold; width: 40%;">Nama Lengkap:</td>
                    <td id="detail_name" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Email:</td>
                    <td id="detail_email" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Cabang:</td>
                    <td id="detail_branch" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Kelas:</td>
                    <td id="detail_class" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Sekolah:</td>
                    <td id="detail_school" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Nomor HP:</td>
                    <td id="detail_phone" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Tanggal Daftar:</td>
                    <td id="detail_created" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Password:</td>
                    <td style="padding: 1rem;">
                        <button onclick="showResetPasswordForm()" class="btn btn-warning" style="padding: 0.5rem 1rem;">
                            üîë Reset Password
                        </button>
                    </td>
                </tr>
            </table>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('studentDetailsModal')" class="btn btn-secondary">Tutup</button>
        </div>
    </div>
</div>

<div id="resetPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reset Password Siswa</h3>
            <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('admin_reset_student_password') }}">
            <input type="hidden" id="reset_student_id" name="student_id">
            <div class="form-group">
                <label>Nama Siswa:</label>
                <input type="text" id="reset_student_name" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Password Baru:</label>
                <input type="text" name="new_password" class="form-control" required placeholder="Masukkan password baru">
                <small class="text-muted">Password minimal 6 karakter</small>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Reset Password</button>
        </form>
    </div>
</div>

<div id="editStudentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Data Siswa</h3>
            <span class="close" onclick="closeModal('editStudentModal')">&times;</span>
        </div>
        <form method="POST" id="editStudentForm">
            <div class="form-group">
                <label>Nama Lengkap:</label>
                <input type="text" id="edit_full_name" name="full_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="edit_email" name="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Cabang:</label>
                <select id="edit_branch" name="inspira_branch" class="form-control" required>
                    {% for branch in branches %}
                    <option value="{{ branch }}">{{ branch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Kelas:</label>
                <select id="edit_class" name="class_level" class="form-control" required>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="Alumni">Alumni</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nama Sekolah:</label>
                <input type="text" id="edit_school" name="school_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Nomor HP:</label>
                <input type="tel" id="edit_phone" name="phone_number" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Simpan Perubahan</button>
        </form>
    </div>
</div>

<script>
let currentStudentId = null;
let currentStudentName = null;

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.student-detail-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            currentStudentId = this.getAttribute('data-id');
            currentStudentName = this.getAttribute('data-name');
            const email = this.getAttribute('data-email');
            const branch = this.getAttribute('data-branch');
            const classLevel = this.getAttribute('data-class');
            const school = this.getAttribute('data-school');
            const phone = this.getAttribute('data-phone');
            const created = this.getAttribute('data-created');
            
            document.getElementById('detail_name').textContent = currentStudentName;
            document.getElementById('detail_email').textContent = email;
            document.getElementById('detail_branch').textContent = branch;
            document.getElementById('detail_class').textContent = classLevel;
            document.getElementById('detail_school').textContent = school;
            document.getElementById('detail_phone').textContent = phone;
            document.getElementById('detail_created').textContent = created;
            
            showModal('studentDetailsModal');
        });
    });
    
    document.querySelectorAll('.student-edit-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const email = this.getAttribute('data-email');
            const branch = this.getAttribute('data-branch');
            const classLevel = this.getAttribute('data-class');
            const school = this.getAttribute('data-school');
            const phone = this.getAttribute('data-phone');
            
            document.getElementById('edit_full_name').value = name;
            document.getElementById('edit_email').value = email;
            document.getElementById('edit_branch').value = branch;
            document.getElementById('edit_class').value = classLevel;
            document.getElementById('edit_school').value = school;
            document.getElementById('edit_phone').value = phone;
            
            document.getElementById('editStudentForm').action = '{{ url_for("admin_edit_student", id=0) }}'.replace('/0', '/' + id);
            
            showModal('editStudentModal');
        });
    });
});

function showResetPasswordForm() {
    closeModal('studentDetailsModal');
    document.getElementById('reset_student_id').value = currentStudentId;
    document.getElementById('reset_student_name').value = currentStudentName;
    showModal('resetPasswordModal');
}

document.querySelectorAll('.student-clear-cheating-btn').forEach(function(button) {
    button.addEventListener('click', function() {
        const studentId = this.getAttribute('data-id');
        const studentName = this.getAttribute('data-name');
        
        showModal('clearCheatingModal');
        document.getElementById('clear_student_id').value = studentId;
        document.getElementById('clear_student_name').textContent = studentName;
        
        document.querySelectorAll('.clear-cheating-form').forEach(form => {
            if (!form.hasAttribute('data-original-action')) {
                form.setAttribute('data-original-action', form.action);
            }
            const originalAction = form.getAttribute('data-original-action');
            form.action = originalAction.replace('/0/', '/' + studentId + '/');
        });
    });
});
</script>

<div id="clearCheatingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Beri Kesempatan Siswa</h3>
            <span class="close" onclick="closeModal('clearCheatingModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>Siswa: <strong id="clear_student_name"></strong></p>
            <p>Pilih TO yang ingin dibuka kembali:</p>
            <input type="hidden" id="clear_student_id">
            <div id="exam_list">
                {% for exam in exams if exam is defined %}
                <form method="POST" action="{{ url_for('admin_clear_cheating', student_id=0, exam_id=exam.id) }}" style="margin-bottom: 0.5rem;" class="clear-cheating-form" data-original-action="{{ url_for('admin_clear_cheating', student_id=0, exam_id=exam.id) }}">
                    <button type="submit" class="btn btn-success" style="width: 100%;">{{ exam.title }}</button>
                </form>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
