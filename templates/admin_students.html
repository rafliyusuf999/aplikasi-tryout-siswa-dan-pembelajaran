{% extends "base.html" %}

{% block title %}Kelola Siswa - Admin{% endblock %}

{% block content %}
<h1 style="color: var(--primary-color); margin-bottom: 2rem;">üë®‚Äçüéì Kelola Siswa</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h2>Daftar Siswa</h2>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <form method="GET" action="{{ url_for('admin_students') }}" style="display: flex; gap: 0.5rem;">
                <input type="text" name="search" class="form-control" placeholder="Cari nama siswa..." value="{{ search_query or '' }}" style="min-width: 200px;">
                <button type="submit" class="btn btn-primary">Cari</button>
                {% if search_query %}
                <a href="{{ url_for('admin_students') }}" class="btn btn-secondary">Reset</a>
                {% endif %}
            </form>
            <button onclick="showModal('addStudentModal')" class="btn btn-primary">+ Tambah Siswa</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>Cabang</th>
                    <th>Kelas</th>
                    <th>Sekolah</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.full_name }}</td>
                    <td>{{ student.email }}</td>
                    <td>{{ student.inspira_branch }}</td>
                    <td>{{ student.class_level }}</td>
                    <td>{{ student.school_name }}</td>
                    <td>
                        <button 
                            class="btn btn-primary student-detail-btn" 
                            style="padding: 0.5rem 1rem; margin-right: 0.5rem;"
                            data-id="{{ student.id }}"
                            data-name="{{ student.full_name }}"
                            data-email="{{ student.email }}"
                            data-branch="{{ student.inspira_branch }}"
                            data-class="{{ student.class_level }}"
                            data-school="{{ student.school_name }}"
                            data-phone="{{ student.phone_number or '-' }}"
                            data-created="{{ student.created_at.strftime('%d/%m/%Y %H:%M') }}"
                            data-password="{{ student.password_hash }}">
                            Detail
                        </button>
                        <form method="POST" action="{{ url_for('admin_delete_student', id=student.id) }}" style="display: inline;" data-confirm-delete>
                            <button type="submit" class="btn btn-danger" style="padding: 0.5rem 1rem;">Hapus</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="addStudentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tambah Siswa Baru</h3>
            <span class="close" onclick="closeModal('addStudentModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('admin_add_student') }}">
            <div class="form-group">
                <label>Nama Lengkap:</label>
                <input type="text" name="full_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" name="password" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Cabang:</label>
                <select name="inspira_branch" class="form-control" required>
                    {% for branch in branches %}
                    <option value="{{ branch }}">{{ branch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Kelas:</label>
                <select name="class_level" class="form-control" required>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="Alumni">Alumni</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nama Sekolah:</label>
                <input type="text" name="school_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Nomor HP:</label>
                <input type="tel" name="phone_number" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Tambah</button>
        </form>
    </div>
</div>

<div id="studentDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Biodata Siswa</h3>
            <span class="close" onclick="closeModal('studentDetailsModal')">&times;</span>
        </div>
        <div class="modal-body">
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold; width: 40%;">Nama Lengkap:</td>
                    <td id="detail_name" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Email:</td>
                    <td id="detail_email" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Cabang:</td>
                    <td id="detail_branch" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Kelas:</td>
                    <td id="detail_class" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Sekolah:</td>
                    <td id="detail_school" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Nomor HP:</td>
                    <td id="detail_phone" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Tanggal Daftar:</td>
                    <td id="detail_created" style="padding: 1rem;"></td>
                </tr>
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 1rem; font-weight: bold;">Password:</td>
                    <td style="padding: 1rem;">
                        <button onclick="showResetPasswordForm()" class="btn btn-warning" style="padding: 0.5rem 1rem;">
                            üîë Reset Password
                        </button>
                    </td>
                </tr>
            </table>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('studentDetailsModal')" class="btn btn-secondary">Tutup</button>
        </div>
    </div>
</div>

<div id="resetPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reset Password Siswa</h3>
            <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('admin_reset_student_password') }}">
            <input type="hidden" id="reset_student_id" name="student_id">
            <div class="form-group">
                <label>Nama Siswa:</label>
                <input type="text" id="reset_student_name" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Password Baru:</label>
                <input type="text" name="new_password" class="form-control" required placeholder="Masukkan password baru">
                <small class="text-muted">Password minimal 6 karakter</small>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Reset Password</button>
        </form>
    </div>
</div>

<script>
let currentStudentId = null;
let currentStudentName = null;

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.student-detail-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            currentStudentId = this.getAttribute('data-id');
            currentStudentName = this.getAttribute('data-name');
            const email = this.getAttribute('data-email');
            const branch = this.getAttribute('data-branch');
            const classLevel = this.getAttribute('data-class');
            const school = this.getAttribute('data-school');
            const phone = this.getAttribute('data-phone');
            const created = this.getAttribute('data-created');
            
            document.getElementById('detail_name').textContent = currentStudentName;
            document.getElementById('detail_email').textContent = email;
            document.getElementById('detail_branch').textContent = branch;
            document.getElementById('detail_class').textContent = classLevel;
            document.getElementById('detail_school').textContent = school;
            document.getElementById('detail_phone').textContent = phone;
            document.getElementById('detail_created').textContent = created;
            
            showModal('studentDetailsModal');
        });
    });
});

function showResetPasswordForm() {
    closeModal('studentDetailsModal');
    document.getElementById('reset_student_id').value = currentStudentId;
    document.getElementById('reset_student_name').value = currentStudentName;
    showModal('resetPasswordModal');
}
</script>
{% endblock %}
