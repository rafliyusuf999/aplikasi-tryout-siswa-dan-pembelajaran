{% extends "base.html" %}

{% block title %}Ujian - {{ exam.title }}{% endblock %}

{% block content %}
<div id="timer" class="timer"></div>

<h1 style="color: var(--primary-color); margin-bottom: 2rem;">{{ exam.title }}</h1>

<div class="exam-questions">
    <form id="examForm">
        {% for question in questions %}
        <div class="question-card">
            <h4>Soal #{{ question.question_order }}</h4>
            <p><strong>{{ question.category }}</strong></p>
            <p>{{ question.question_text }}</p>
            
            {% if question.question_type == 'multiple_choice' %}
            <div class="options">
                <label class="option-item">
                    <input type="radio" name="q_{{ question.id }}" value="A">
                    <span>A. {{ question.option_a }}</span>
                </label>
                <label class="option-item">
                    <input type="radio" name="q_{{ question.id }}" value="B">
                    <span>B. {{ question.option_b }}</span>
                </label>
                <label class="option-item">
                    <input type="radio" name="q_{{ question.id }}" value="C">
                    <span>C. {{ question.option_c }}</span>
                </label>
                <label class="option-item">
                    <input type="radio" name="q_{{ question.id }}" value="D">
                    <span>D. {{ question.option_d }}</span>
                </label>
                {% if question.option_e %}
                <label class="option-item">
                    <input type="radio" name="q_{{ question.id }}" value="E">
                    <span>E. {{ question.option_e }}</span>
                </label>
                {% endif %}
            </div>
            {% else %}
            <div class="form-group" style="margin-top: 1rem;">
                <label>Jawaban Esai (Upload Foto):</label>
                <input type="file" id="essay_{{ question.id }}" accept="image/*" class="form-control" style="margin-top: 10px;">
                <div id="preview_{{ question.id }}" style="margin-top: 10px;"></div>
                <small class="text-muted">Upload foto jawaban esai Anda (JPG, PNG, max 5MB)</small>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </form>
    
    <button onclick="submitExam()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.2rem; margin-top: 2rem;">Submit Jawaban</button>
</div>

<script>
showSecurityWarningModal();

let timerStarted = false;
let antiCheatEnabled = false;

function startExamAfterWarning() {
    if (!timerStarted) {
        const timer = new ExamTimer({{ exam.duration_minutes }}, function() {
            alert('Waktu habis! Jawaban Anda akan otomatis disubmit.');
            submitExam();
        });
        timer.start('timer');
        timerStarted = true;
    }
    
    if (!antiCheatEnabled) {
        const antiCheat = new AntiCheat(
            function(count, message) {
                console.log('Warning #' + count + ': ' + message);
            },
            '{{ url_for("logout") }}',
            '{{ url_for("student_start_exam", id=exam.id) }}'
        );
        antiCheat.enable();
        antiCheatEnabled = true;
    }
}

document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const questionId = this.id.replace('essay_', '');
        const preview = document.getElementById('preview_' + questionId);
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;">`;
            };
            reader.readAsDataURL(file);
        }
    });
});

async function submitExam() {
    if (!confirm('Apakah Anda yakin ingin submit jawaban?')) {
        return;
    }
    
    const form = document.getElementById('examForm');
    const formData = new FormData(form);
    const answers = {};
    const essayFiles = {};
    
    for (let [key, value] of formData.entries()) {
        const questionId = key.replace('q_', '');
        answers[questionId] = value;
    }
    
    document.querySelectorAll('input[type="file"]').forEach(input => {
        const questionId = input.id.replace('essay_', '');
        if (input.files[0]) {
            essayFiles[questionId] = input.files[0];
        }
    });
    
    try {
        const uploadPromises = [];
        for (const [questionId, file] of Object.entries(essayFiles)) {
            const uploadFormData = new FormData();
            uploadFormData.append('essay_file', file);
            uploadFormData.append('question_id', questionId);
            
            const promise = fetch('{{ url_for("student_upload_essay", attempt_id=attempt.id) }}', {
                method: 'POST',
                body: uploadFormData
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Upload foto gagal untuk soal ' + questionId);
                }
                return response.json();
            }).then(data => {
                if (!data.success) {
                    throw new Error('Upload foto gagal untuk soal ' + questionId + ': ' + (data.message || 'Error tidak diketahui'));
                }
                return data;
            });
            uploadPromises.push(promise);
        }
        
        await Promise.all(uploadPromises);
        
        const submitData = new FormData();
        submitData.append('answers', JSON.stringify(answers));
        
        const submitResponse = await fetch('{{ url_for("student_submit_exam", attempt_id=attempt.id) }}', {
            method: 'POST',
            body: submitData
        });
        
        const submitResult = await submitResponse.json();
        
        if (submitResult.success) {
            window.location.href = submitResult.redirect;
        } else {
            alert('Gagal submit jawaban: ' + (submitResult.message || 'Error tidak diketahui'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
        return;
    }
}
</script>
{% endblock %}
